<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatat Keuangan v4</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (xlsx) for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-react@0.395.0/dist/lucide.min.js"></script>

    <style>
        :root {
            --bg-primary: #111827; /* bg-gray-900 */
            --bg-secondary: #1f2937; /* bg-gray-800 */
            --bg-tertiary: #374151; /* bg-gray-700 */
            --text-primary: #f9fafb; /* text-gray-50 */
            --text-secondary: #d1d5db; /* text-gray-300 */
            --accent-color: #22d3ee; /* cyan-400 */
            --accent-hover: #06b6d4; /* cyan-500 */
        }
        .theme-light {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
        }
        .theme-sunset {
            --bg-primary: #2d1a2e;
            --bg-secondary: #4a2f48;
            --bg-tertiary: #71496b;
            --text-primary: #fde8e3;
            --text-secondary: #f6c8be;
            --accent-color: #f58a77;
            --accent-hover: #f26b52;
        }
        .theme-vibrant {
            --bg-primary: #0d1b2a;
            --bg-secondary: #1b263b;
            --bg-tertiary: #415a77;
            --text-primary: #e0e1dd;
            --text-secondary: #b1b3b0;
            --accent-color: #ffd60a;
            --accent-hover: #ffc300;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-app-secondary { background-color: var(--bg-secondary); }
        .bg-app-tertiary { background-color: var(--bg-tertiary); }
        .text-app-primary { color: var(--text-primary); }
        .text-app-secondary { color: var(--text-secondary); }
        .border-app-tertiary { border-color: var(--bg-tertiary); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); }
        .accent-bg-hover:hover { background-color: var(--accent-hover); }
        .accent-ring { ring-color: var(--accent-color); }
        .icon-color { color: var(--text-primary); }

        #main-container {
            position: relative;
            z-index: 1;
            transition: filter 0.3s ease-in-out;
        }
        #main-container.blurred {
            filter: blur(5px) brightness(0.7);
        }
        #wallpaper-container {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
            opacity: 0.1;
            transition: background-image 0.5s;
        }
        .hidden { display: none; }
        .modal-backdrop { background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .new-item-animation { animation: slideIn 0.5s ease-out forwards; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .balance-update-animation { animation: pulse 0.7s ease; }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        /* Toast Notification Styles */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            animation: toastIn 0.5s ease;
        }
        .toast.hiding {
            animation: toastOut 0.5s ease forwards;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }
        
        /* Settings Panel */
        #settings-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        #settings-panel {
            transition: transform 0.3s ease-in-out;
        }
        #settings-overlay.hidden #settings-panel {
            transform: translateY(100%);
        }
    </style>
</head>
<body class="text-white">

    <div id="wallpaper-container"></div>
    <div id="toast-container"></div>
    <div id="main-container" class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <div>
                <h1 id="main-title" class="text-3xl md:text-4xl font-bold accent-text">Pencatat Keuangan</h1>
                <p id="subtitle" class="text-app-secondary mt-2">Selamat datang!</p>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-1 flex flex-col gap-8">
                <!-- Dashboard -->
                <section class="bg-app-secondary p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2" style="border-color: var(--bg-tertiary);">Ringkasan Bulan Ini</h2>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-app-tertiary rounded-lg"><span class="text-app-secondary">Saldo Akhir</span><span id="balance" class="font-bold text-xl text-green-400">Rp 0</span></div>
                        <div class="flex justify-between items-center p-3 bg-app-tertiary rounded-lg"><span class="text-app-secondary">Total Pemasukan</span><span id="total-income" class="font-bold text-lg accent-text">Rp 0</span></div>
                        <div class="flex justify-between items-center p-3 bg-app-tertiary rounded-lg"><span class="text-app-secondary">Total Pengeluaran</span><span id="total-expense" class="font-bold text-lg text-red-400">Rp 0</span></div>
                    </div>
                    <!-- ✨ Gemini Feature: AI Insight -->
                    <div class="mt-6">
                         <button id="ai-insight-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition">
                            <i data-lucide="sparkles" class="w-5 h-5"></i> Minta Analisis AI
                        </button>
                        <div id="ai-insight-result" class="mt-4 text-sm text-app-secondary bg-app-tertiary p-3 rounded-lg hidden"></div>
                    </div>
                </section>
                
                <!-- Gamification: Pohon Uang -->
                <section class="bg-app-secondary p-6 rounded-2xl shadow-lg text-center">
                    <h2 class="text-2xl font-semibold mb-2">Pohon Uangmu</h2>
                    <div id="tree-container" class="h-48 flex items-center justify-center"></div>
                    <p id="tree-status" class="text-sm text-app-secondary mt-2">Jaga pohonmu dengan menabung!</p>
                </section>

                <!-- Transaction Form -->
                <section class="bg-app-secondary p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4">Tambah Transaksi Baru</h2>
                    <form id="transaction-form" class="space-y-4">
                        <!-- Form fields here -->
                         <div>
                            <label class="block text-sm font-medium text-app-secondary mb-2">Jenis Transaksi</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" id="type-income-btn" class="w-full p-2 rounded-lg font-semibold accent-bg accent-ring ring-2">Pemasukan</button>
                                <button type="button" id="type-expense-btn" class="w-full bg-app-tertiary p-2 rounded-lg font-semibold">Pengeluaran</button>
                                <input type="hidden" id="type" value="income">
                            </div>
                        </div>
                        <div>
                            <label for="description" class="block text-sm font-medium text-app-secondary">Deskripsi</label>
                            <input type="text" id="description" placeholder="Makan siang di warung" class="mt-1 block w-full bg-app-tertiary border-app-tertiary rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2.5" required>
                        </div>
                         <div class="relative">
                            <label for="category" class="block text-sm font-medium text-app-secondary">Kategori</label>
                            <select id="category" class="mt-1 block w-full bg-app-tertiary border-app-tertiary rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2.5" required></select>
                             <!-- ✨ Gemini Feature: AI Category Suggestion Loader -->
                            <div id="ai-cat-loader" class="absolute right-3 top-9 hidden animate-spin"><i data-lucide="loader-2" class="w-5 h-5 accent-text"></i></div>
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-app-secondary">Jumlah</label>
                            <input type="number" id="amount" placeholder="Contoh: 50000" class="mt-1 block w-full bg-app-tertiary border-app-tertiary rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2.5" required>
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-app-secondary">Tanggal</label>
                            <input type="date" id="date" class="mt-1 block w-full bg-app-tertiary border-app-tertiary rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2.5" required>
                        </div>
                        <button type="submit" class="w-full accent-bg accent-bg-hover text-white font-bold py-3 px-4 rounded-lg transition duration-300 shadow-lg">Simpan Transaksi</button>
                    </form>
                </section>
            </div>

            <!-- Right Column -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <!-- Calendar View -->
                <section class="bg-app-secondary p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-app-tertiary"><i data-lucide="chevron-left" class="icon-color"></i></button>
                        <h2 id="calendar-title" class="text-2xl font-semibold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-app-tertiary"><i data-lucide="chevron-right" class="icon-color"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
                </section>

                <!-- Transaction History -->
                <section class="bg-app-secondary p-6 rounded-2xl shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex-grow">
                            <h2 id="history-title" class="text-2xl font-semibold">Riwayat Transaksi</h2>
                        </div>
                        <div class="flex items-center gap-2">
                           <button id="show-all-btn" class="text-sm accent-text hover:underline hidden">Tampilkan Semua</button>
                           <button id="export-excel-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm">Export ke Excel</button>
                        </div>
                    </div>
                    <div id="transaction-list" class="mt-4 space-y-3 max-h-[500px] overflow-y-auto pr-2"></div>
                </section>
            </div>
        </main>
    </div>

    <!-- Floating Action Button for Settings -->
    <button id="open-settings-fab" class="fixed bottom-6 right-6 accent-bg accent-bg-hover text-white p-4 rounded-full shadow-lg z-20">
        <i data-lucide="settings" class="w-6 h-6"></i>
    </button>

    <!-- Modals -->
    <div id="name-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop">
        <div class="bg-app-secondary rounded-2xl shadow-2xl w-full max-w-sm m-4 p-6 text-center">
            <h3 class="text-2xl font-semibold mb-2">Selamat Datang!</h3>
            <p class="text-app-secondary mb-4">Siapa nama panggilanmu?</p>
            <form id="name-form">
                <input type="text" id="name-input" class="w-full bg-app-tertiary p-3 rounded-lg text-center" placeholder="Contoh: Budi" required>
                <button type="submit" class="w-full mt-4 accent-bg accent-bg-hover text-white font-bold py-3 rounded-lg">Simpan</button>
            </form>
        </div>
    </div>

    <!-- NEW: Full Screen Settings Panel -->
    <div id="settings-overlay" class="fixed inset-0 z-30 hidden bg-black/50 backdrop-blur-sm" style="opacity: 0;">
        <div id="settings-panel" class="absolute bottom-0 left-0 right-0 bg-app-secondary rounded-t-3xl p-4 md:p-8 max-h-[90vh] overflow-y-auto">
            <div class="max-w-4xl mx-auto">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Pengaturan</h2>
                    <button id="close-settings-btn" class="p-2 rounded-full hover:bg-app-tertiary">
                        <i data-lucide="x" class="w-6 h-6 icon-color"></i>
                    </button>
                </div>
                
                <!-- Tab Buttons -->
                <div class="border-b border-app-tertiary mb-6">
                    <nav class="flex -mb-px space-x-6">
                        <button class="settings-tab-btn py-4 px-1 border-b-2 font-medium text-lg border-transparent" data-tab="tampilan">Tampilan</button>
                        <button class="settings-tab-btn py-4 px-1 border-b-2 font-medium text-lg border-transparent" data-tab="kategori">Kategori</button>
                        <button class="settings-tab-btn py-4 px-1 border-b-2 font-medium text-lg border-transparent" data-tab="data">Data & AI</button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div id="settings-tab-content">
                    <!-- Tampilan Tab -->
                    <div id="tab-tampilan" class="settings-tab-panel space-y-8">
                        <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4">Profil Pengguna</h3>
                            <div class="flex items-center justify-between">
                                <span id="current-user-name" class="font-medium text-lg"></span>
                                <button id="change-name-btn" class="text-sm accent-text hover:underline">Ganti Nama</button>
                            </div>
                        </div>
                        <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4">Tema Warna</h3>
                            <div id="theme-selector" class="grid grid-cols-2 gap-3">
                                <button data-theme="dark" class="p-4 rounded-lg text-left" style="background-color: #111827; color: #f9fafb;">Dark</button>
                                <button data-theme="light" class="p-4 rounded-lg text-left" style="background-color: #f9fafb; color: #111827;">Light</button>
                                <button data-theme="sunset" class="p-4 rounded-lg text-left" style="background-color: #2d1a2e; color: #fde8e3;">Sunset</button>
                                <button data-theme="vibrant" class="p-4 rounded-lg text-left" style="background-color: #0d1b2a; color: #e0e1dd;">Vibrant</button>
                            </div>
                        </div>
                         <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4">Wallpaper Latar</h3>
                            <input type="text" id="wallpaper-url-input" class="w-full bg-app-primary p-3 rounded-lg" placeholder="Masukkan URL gambar...">
                            <p class="text-xs text-app-secondary mt-2">Kosongkan untuk menghapus wallpaper.</p>
                        </div>
                    </div>
                    <!-- Kategori Tab -->
                    <div id="tab-kategori" class="settings-tab-panel hidden">
                        <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4">Kelola Kategori</h3>
                            <div id="category-management-container"></div>
                        </div>
                    </div>
                    <!-- Data & AI Tab -->
                    <div id="tab-data" class="settings-tab-panel hidden space-y-8">
                        <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4">Koneksi AI (Gemini)</h3>
                            <label for="api-key-input" class="block text-sm font-medium text-app-secondary mb-2">Kunci API Gemini</label>
                            <input type="password" id="api-key-input" class="w-full bg-app-primary p-3 rounded-lg" placeholder="Masukkan kunci API Gemini milikmu">
                            <p class="text-xs text-app-secondary mt-2">Kunci API-mu disimpan dengan aman di browser ini saja.</p>
                        </div>
                        <div class="bg-app-tertiary p-6 rounded-2xl">
                            <h3 class="text-xl font-semibold mb-4 text-red-500">Manajemen Data</h3>
                            <div class="space-y-4">
                                <button id="delete-history-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg">Hapus Riwayat Transaksi</button>
                                <button id="delete-all-data-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Reset Aplikasi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"><div class="bg-app-secondary rounded-2xl shadow-2xl w-full max-w-sm m-4 p-6 text-center"><div id="confirmation-icon-container" class="flex justify-center mb-4"></div><h3 id="confirmation-title" class="text-xl font-semibold mb-2"></h3><p id="confirmation-message" class="text-app-secondary mb-6"></p><div id="confirmation-buttons" class="flex justify-center gap-4"></div></div></div>
    
    <!-- Script utama aplikasi -->
    <script type="module">
        // State aplikasi
        let transactions = [];
        let categories = [];
        let userName = '';
        let currentTheme = 'dark';
        let currentWallpaper = '';
        let userApiKey = '';
        let currentDate = new Date();
        let selectedDate = null;
        let expenseChart = null;
        let aiCategorizeTimeout;

        // Sound effects
        const incomeSound = new Tone.Synth({
            oscillator: { type: "sine" },
            envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
        }).toDestination();

        const expenseSound = new Tone.Synth({
            oscillator: { type: "triangle" },
            envelope: { attack: 0.01, decay: 0.2, sustain: 0.2, release: 0.5 }
        }).toDestination();
        
        // ===================================
        // Inisialisasi
        // ===================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadDataFromLocalStorage();
            setupEventListeners();
            
            if (!userName) {
                document.getElementById('name-modal').classList.remove('hidden');
            } else {
                updateWelcomeMessage();
            }

            renderAll();
            safeCreateIcons();
        });

        function loadSettings() {
            userName = localStorage.getItem('keuangan_userName') || '';
            currentTheme = localStorage.getItem('keuangan_theme') || 'dark';
            currentWallpaper = localStorage.getItem('keuangan_wallpaper') || '';
            userApiKey = localStorage.getItem('keuangan_apiKey') || '';
            
            applyTheme(currentTheme);
            applyWallpaper(currentWallpaper);
            document.getElementById('api-key-input').value = userApiKey;
        }

        function loadDataFromLocalStorage() {
            transactions = JSON.parse(localStorage.getItem('keuangan_transactions_v4') || '[]');
            categories = JSON.parse(localStorage.getItem('keuangan_categories_v4') || 'null');

            if (!categories) {
                categories = [
                    { id: crypto.randomUUID(), name: 'Gaji', type: 'income' }, 
                    { id: crypto.randomUUID(), name: 'Bonus', type: 'income' },
                    { id: crypto.randomUUID(), name: 'Makanan & Minuman', type: 'expense' }, 
                    { id: crypto.randomUUID(), name: 'Transportasi', type: 'expense' },
                    { id: crypto.randomUUID(), name: 'Tagihan', type: 'expense' }, 
                    { id: crypto.randomUUID(), name: 'Belanja', type: 'expense' },
                    { id: crypto.randomUUID(), name: 'Hiburan', type: 'expense' }, 
                    { id: crypto.randomUUID(), name: 'Kesehatan', type: 'expense' },
                ];
                saveCategoriesToLocalStorage();
            }
        }

        function saveTransactionsToLocalStorage() {
            localStorage.setItem('keuangan_transactions_v4', JSON.stringify(transactions));
        }

        function saveCategoriesToLocalStorage() {
            localStorage.setItem('keuangan_categories_v4', JSON.stringify(categories));
        }

        // ===================================
        // Event Listeners
        // ===================================
        function setupEventListeners() {
            document.getElementById('name-form').addEventListener('submit', handleNameSubmit);
            document.getElementById('open-settings-fab').addEventListener('click', openSettings);
            document.getElementById('close-settings-btn').addEventListener('click', closeSettings);
            document.getElementById('settings-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'settings-overlay') closeSettings();
            });
            document.getElementById('transaction-form').addEventListener('submit', handleAddTransaction);
            document.getElementById('theme-selector').addEventListener('click', handleThemeChange);
            document.getElementById('wallpaper-url-input').addEventListener('change', handleWallpaperChange);
            document.getElementById('api-key-input').addEventListener('change', handleApiKeyChange);
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
            document.getElementById('calendar-grid').addEventListener('click', handleDateClick);
            document.getElementById('show-all-btn').addEventListener('click', handleShowAll);
            document.getElementById('type-income-btn').addEventListener('click', () => switchTransactionType('income'));
            document.getElementById('type-expense-btn').addEventListener('click', () => switchTransactionType('expense'));
            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
            document.getElementById('change-name-btn').addEventListener('click', handleChangeName);
            document.getElementById('delete-history-btn').addEventListener('click', handleDeleteHistory);
            document.getElementById('delete-all-data-btn').addEventListener('click', handleDeleteAllData);
            document.getElementById('description').addEventListener('input', handleDescriptionInput);
            document.getElementById('ai-insight-btn').addEventListener('click', generateAiInsight);
            
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('accent-text', 'border-accent-color'));
                    e.target.classList.add('accent-text', 'border-accent-color');
                    
                    document.querySelectorAll('.settings-tab-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(`tab-${tabId}`).classList.remove('hidden');
                });
            });
        }

        // ===================================
        // Handlers
        // ===================================
        function openSettings() {
            const overlay = document.getElementById('settings-overlay');
            const panel = document.getElementById('settings-panel');
            document.getElementById('main-container').classList.add('blurred');
            document.getElementById('open-settings-fab').classList.add('hidden');
            
            document.getElementById('current-user-name').textContent = userName;
            document.getElementById('wallpaper-url-input').value = currentWallpaper;
            renderCategoryManagement();
            
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            }, 10);

            // Activate first tab by default
            document.querySelector('.settings-tab-btn[data-tab="tampilan"]').click();
        }

        function closeSettings() {
            const overlay = document.getElementById('settings-overlay');
            const panel = document.getElementById('settings-panel');
            document.getElementById('main-container').classList.remove('blurred');
            document.getElementById('open-settings-fab').classList.remove('hidden');

            overlay.style.opacity = '0';
            panel.style.transform = 'translateY(100%)';
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        }

        function handleNameSubmit(e) {
            e.preventDefault();
            const nameInput = document.getElementById('name-input');
            userName = nameInput.value.trim();
            if (userName) {
                localStorage.setItem('keuangan_userName', userName);
                updateWelcomeMessage();
                document.getElementById('name-modal').classList.add('hidden');
            }
        }
        
        function handleChangeName() {
            const newName = prompt("Masukkan nama baru:", userName);
            if (newName && newName.trim() !== '') {
                userName = newName.trim();
                localStorage.setItem('keuangan_userName', userName);
                updateWelcomeMessage();
                showToast('Nama berhasil diubah!', 'success');
            }
        }

        function handleDeleteHistory() {
             showConfirmationModal(
                'Hapus Riwayat Transaksi?',
                'Tindakan ini akan menghapus semua data transaksi, tapi kategori dan pengaturan lain akan tetap ada. Anda yakin?',
                () => {
                    transactions = [];
                    localStorage.removeItem('keuangan_transactions_v4');
                    renderAll();
                    showToast('Semua riwayat transaksi berhasil dihapus.', 'success');
                }
            );
        }

        function handleDeleteAllData() {
            showConfirmationModal(
                'Reset Aplikasi?',
                'Tindakan ini akan menghapus SEMUA data (transaksi, kategori, nama, tema, dll) dan mengembalikan aplikasi ke kondisi awal. Anda yakin?',
                () => {
                    transactions = [];
                    categories = [];
                    userName = '';
                    localStorage.removeItem('keuangan_transactions_v4');
                    localStorage.removeItem('keuangan_categories_v4');
                    localStorage.removeItem('keuangan_userName');
                    localStorage.removeItem('keuangan_theme');
                    localStorage.removeItem('keuangan_wallpaper');
                    localStorage.removeItem('keuangan_apiKey');
                    loadDataFromLocalStorage(); // to re-init default categories
                    loadSettings();
                    renderAll();
                    closeSettings();
                    document.getElementById('name-modal').classList.remove('hidden');
                    showToast('Aplikasi berhasil di-reset.', 'success');
                }
            );
        }

        function handleThemeChange(e) {
            if (e.target.tagName === 'BUTTON') {
                const theme = e.target.dataset.theme;
                applyTheme(theme);
                localStorage.setItem('keuangan_theme', theme);
            }
        }

        function handleWallpaperChange(e) {
            const url = e.target.value.trim();
            applyWallpaper(url);
            localStorage.setItem('keuangan_wallpaper', url);
        }

        function handleApiKeyChange(e) {
            userApiKey = e.target.value.trim();
            localStorage.setItem('keuangan_apiKey', userApiKey);
            showToast('Kunci API berhasil disimpan!', 'success');
        }

        function handleAddTransaction(e) {
            e.preventDefault();
            const newTransaction = {
                id: crypto.randomUUID(),
                type: document.getElementById('type').value,
                amount: parseFloat(document.getElementById('amount').value),
                categoryId: document.getElementById('category').value,
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
            };
            
            transactions.push(newTransaction);
            saveTransactionsToLocalStorage();
            
            if (Tone.context.state !== 'running') {
                Tone.start();
            }

            if (newTransaction.type === 'income') {
                incomeSound.triggerAttackRelease("C5", "8n", Tone.now());
                showToast(`Pemasukan ${formatCurrency(newTransaction.amount)} berhasil ditambahkan!`, 'success');
            } else {
                expenseSound.triggerAttackRelease("C3", "8n", Tone.now());
                showToast(`Pengeluaran ${formatCurrency(newTransaction.amount)} ditambahkan.`, 'expense');
            }

            const balanceEl = document.getElementById('balance');
            balanceEl.classList.add('balance-update-animation');
            setTimeout(() => balanceEl.classList.remove('balance-update-animation'), 700);
            
            renderAll();
            document.getElementById('transaction-form').reset();
            setDateToToday();
        }

        function handleDateClick(e) {
            const target = e.target.closest('.calendar-day');
            if (target && target.dataset.date) {
                selectedDate = target.dataset.date;
                document.getElementById('show-all-btn').classList.remove('hidden');
                renderAll();
            }
        }

        function handleShowAll() {
            selectedDate = null;
            document.getElementById('show-all-btn').classList.add('hidden');
            renderAll();
        }
        
        function handleDeleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveTransactionsToLocalStorage();
            renderAll();
            showToast('Transaksi dihapus.', 'info');
        }
        
        function handleAddCategory(e) {
            e.preventDefault();
            const form = e.target;
            const nameInput = form.querySelector('#new-category-name');
            const typeInput = form.querySelector('#new-category-type');
            
            const name = nameInput.value.trim();
            const type = typeInput.value;
            if (!name) { showToast('Nama kategori tidak boleh kosong.', 'error'); return; }
            if (categories.some(c => c.name.toLowerCase() === name.toLowerCase() && c.type === type)) {
                showToast('Kategori dengan nama dan tipe yang sama sudah ada.', 'error');
                return;
            }
            
            categories.push({ id: crypto.randomUUID(), name, type });
            saveCategoriesToLocalStorage();
            renderAll();
            renderCategoryManagement(); // Re-render the management UI
            nameInput.value = '';
        }

        function handleDeleteCategory(id) {
            categories = categories.filter(c => c.id !== id);
            saveCategoriesToLocalStorage();
            renderAll();
            renderCategoryManagement();
        }

        function handleEditCategory(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;
            
            const newName = prompt(`Ubah nama kategori "${category.name}":`, category.name);
            if (newName && newName.trim() !== '') {
                category.name = newName.trim();
                saveCategoriesToLocalStorage();
                renderAll();
                renderCategoryManagement();
                showToast('Kategori berhasil diubah!', 'success');
            }
        }

        // ===================================
        // Rendering
        // ===================================
        function renderAll() {
            renderDashboard();
            renderTransactionList();
            renderCalendar();
            renderTree();
            updateCategoryDropdowns();
            renderExpenseChart();
        }

        function updateWelcomeMessage() {
            document.getElementById('main-title').textContent = `Dashboard Keuangan`;
            document.getElementById('subtitle').textContent = `Selamat datang, ${userName}!`;
            document.getElementById('current-user-name').textContent = userName;
        }

        function applyTheme(theme) {
            document.documentElement.className = `theme-${theme}`;
        }
        
        function applyWallpaper(url) {
            document.getElementById('wallpaper-container').style.backgroundImage = url ? `url(${url})` : 'none';
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const title = document.getElementById('calendar-title');
            grid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            title.textContent = new Intl.DateTimeFormat('id-ID', { month: 'long', year: 'numeric' }).format(currentDate);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const daysOfWeek = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            daysOfWeek.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-semibold text-app-secondary text-sm';
                dayEl.textContent = day;
                grid.appendChild(dayEl);
            });

            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('button');
                dayEl.className = 'calendar-day p-2 rounded-full relative hover:bg-app-tertiary transition-colors duration-200';
                dayEl.dataset.date = dateStr;
                dayEl.textContent = day;

                const todayStr = new Date().toISOString().split('T')[0];
                if (dateStr === todayStr) {
                    dayEl.classList.add('accent-bg');
                }
                if (dateStr === selectedDate) {
                    dayEl.classList.add('ring-2', 'accent-ring');
                }

                const transactionsOnDay = transactions.filter(t => t.date === dateStr);
                if (transactionsOnDay.length > 0) {
                    const dotContainer = document.createElement('div');
                    dotContainer.className = 'absolute bottom-1 left-1/2 -translate-x-1/2 flex gap-0.5';
                    if (transactionsOnDay.some(t => t.type === 'income')) {
                        const dot = document.createElement('div');
                        dot.className = 'w-1.5 h-1.5 accent-bg rounded-full';
                        dotContainer.appendChild(dot);
                    }
                    if (transactionsOnDay.some(t => t.type === 'expense')) {
                        const dot = document.createElement('div');
                        dot.className = 'w-1.5 h-1.5 bg-red-500 rounded-full';
                        dotContainer.appendChild(dot);
                    }
                    dayEl.appendChild(dotContainer);
                }
                grid.appendChild(dayEl);
            }
        }
        
        function renderTransactionList() {
            const listEl = document.getElementById('transaction-list');
            const titleEl = document.getElementById('history-title');
            listEl.innerHTML = '';
            
            let filteredTransactions = transactions;
            if (selectedDate) {
                filteredTransactions = transactions.filter(t => t.date === selectedDate);
                titleEl.textContent = `Riwayat ${new Date(selectedDate).toLocaleDateString('id-ID', {day:'numeric', month:'long'})}`;
            } else {
                titleEl.textContent = 'Riwayat Transaksi';
            }
            
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filteredTransactions.length === 0) {
                listEl.innerHTML = `<p class="text-center text-app-secondary py-8">Tidak ada transaksi.</p>`;
                return;
            }

            filteredTransactions.forEach((t, index) => {
                const category = categories.find(c => c.id === t.categoryId) || { name: 'Tanpa Kategori' };
                const isIncome = t.type === 'income';
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-app-tertiary p-3 rounded-lg new-item-animation';
                item.style.animationDelay = `${index * 50}ms`;
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i data-lucide="${isIncome ? 'arrow-up-circle' : 'arrow-down-circle'}" class="w-8 h-8 ${isIncome ? 'accent-text' : 'text-red-400'}"></i>
                        <div>
                            <p class="font-semibold">${t.description || category.name}</p>
                            <p class="text-sm text-app-secondary">${category.name} &bull; ${new Date(t.date).toLocaleDateString('id-ID')}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-lg ${isIncome ? 'accent-text' : 'text-red-400'}">${isIncome ? '+' : '-'} ${formatCurrency(t.amount)}</span>
                        <button class="delete-btn p-2 text-app-secondary hover:text-white" data-id="${t.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>`;
                listEl.appendChild(item);
            });
            safeCreateIcons();
            
            listEl.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                showConfirmationModal('Konfirmasi Hapus', 'Yakin ingin menghapus transaksi ini?', () => handleDeleteTransaction(id));
            }));
        }

        function renderTree() {
            const container = document.getElementById('tree-container');
            const statusEl = document.getElementById('tree-status');
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            
            let treeLevel = 0;
            if (totalIncome > 5000000) treeLevel = 4;
            else if (totalIncome > 2000000) treeLevel = 3;
            else if (totalIncome > 500000) treeLevel = 2;
            else if (totalIncome > 100000) treeLevel = 1;
            else treeLevel = 0;

            const treeSVGs = [
                `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 80 Q 55 70 60 80" fill="none" stroke="#8B4513" stroke-width="4"/><path d="M50 80 Q 45 70 40 80" fill="none" stroke="#8B4513" stroke-width="4"/><path d="M50 80 V 70 C 50 60, 55 60, 55 70" fill="#32CD32" stroke="#228B22" stroke-width="2"/><path d="M50 80 V 70 C 50 60, 45 60, 45 70" fill="#32CD32" stroke="#228B22" stroke-width="2"/></svg>`,
                `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 90 V 50" stroke="#8B4513" stroke-width="6"/><circle cx="50" cy="40" r="20" fill="#228B22"/></svg>`,
                `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 95 V 40" stroke="#8B4513" stroke-width="10"/><circle cx="50" cy="35" r="30" fill="#228B22"/><circle cx="35" cy="45" r="15" fill="#32CD32"/><circle cx="65" cy="45" r="15" fill="#32CD32"/></svg>`,
                `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 95 V 40" stroke="#8B4513" stroke-width="10"/><circle cx="50" cy="35" r="30" fill="#228B22"/><circle cx="35" cy="45" r="15" fill="#32CD32"/><circle cx="65" cy="45" r="15" fill="#32CD32"/><circle cx="50" cy="15" r="5" fill="#FFC0CB"/><circle cx="30" cy="30" r="5" fill="#FFC0CB"/><circle cx="70" cy="30" r="5" fill="#FFC0CB"/></svg>`,
                `<svg width="100" height="100" viewBox="0 0 100 100"><path d="M50 95 V 40" stroke="#8B4513" stroke-width="10"/><circle cx="50" cy="35" r="30" fill="#228B22"/><circle cx="35" cy="45" r="15" fill="#32CD32"/><circle cx="65" cy="45" r="15" fill="#32CD32"/><circle cx="40" cy="25" r="6" fill="#FFD700" stroke="orange"/><circle cx="60" cy="25" r="6" fill="#FFD700" stroke="orange"/><circle cx="50" cy="45" r="6" fill="#FFD700" stroke="orange"/></svg>`
            ];
            
            container.innerHTML = treeSVGs[treeLevel];
            const statusMessages = ["Tunas baru! Mulai tabung yuk!", "Pohonmu mulai tumbuh!", "Wow, pohonmu semakin besar!", "Indah! Pohonmu berbunga.", "Luar biasa! Pohonmu berbuah emas!"];
            statusEl.textContent = statusMessages[treeLevel];
        }
        
        function renderDashboard() {
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyTransactions = transactions.filter(t => new Date(t.date) >= startOfMonth);
            const totalIncome = monthlyTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = monthlyTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalBalance = transactions.reduce((sum, t) => sum + (t.type === 'income' ? t.amount : -t.amount), 0);
            document.getElementById('balance').textContent = formatCurrency(totalBalance);
            document.getElementById('total-income').textContent = formatCurrency(totalIncome);
            document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
        }

        function renderExpenseChart() {
            const chartCanvas = document.getElementById('expense-chart').getContext('2d');
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= startOfMonth);
            const dataByCat = monthlyExpenses.reduce((acc, t) => {
                const category = categories.find(c => c.id === t.categoryId) || { name: 'Lainnya' };
                acc[category.name] = (acc[category.name] || 0) + t.amount;
                return acc;
            }, {});
            const labels = Object.keys(dataByCat);
            const data = Object.values(dataByCat);
            if (expenseChart) expenseChart.destroy();
            
            const chartContainer = chartCanvas.canvas.parentElement;
            const existingP = chartContainer.querySelector('p');
            if (existingP) existingP.remove();

            if (labels.length === 0) {
                 const p = document.createElement('p');
                 p.className = 'text-center text-app-secondary';
                 p.textContent = 'Belum ada data pengeluaran bulan ini.';
                 chartContainer.appendChild(p);
                 return;
            }

            expenseChart = new Chart(chartCanvas, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pengeluaran', data: data,
                        backgroundColor: ['#22d3ee', '#f87171', '#fbbf24', '#a78bfa', '#34d399', '#fb923c', '#f472b6', '#60a5fa'],
                        borderColor: 'var(--bg-secondary)', borderWidth: 4, hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: 'var(--text-secondary)', boxWidth: 15, padding: 20 } } }
                }
            });
        }

        function updateCategoryDropdowns() {
            const categorySelect = document.getElementById('category');
            const type = document.getElementById('type').value;
            const filteredCategories = categories.filter(c => c.type === type);
            categorySelect.innerHTML = filteredCategories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        }
        
        function renderCategoryManagement() {
            const container = document.getElementById('category-management-container');
            container.innerHTML = `
                <form id="add-category-form" class="flex gap-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="Nama Kategori Baru" class="flex-grow bg-app-tertiary p-2.5 rounded-lg" required>
                    <select id="new-category-type" class="bg-app-tertiary p-2.5 rounded-lg">
                        <option value="expense">Pengeluaran</option>
                        <option value="income">Pemasukan</option>
                    </select>
                    <button type="submit" class="accent-bg accent-bg-hover text-white font-bold p-2.5 rounded-lg transition">Tambah</button>
                </form>
                <div id="category-list" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
            `;
            
            const listEl = container.querySelector('#category-list');
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-app-tertiary p-2.5 rounded-lg';
                item.innerHTML = `
                    <div>
                        <span class="font-semibold">${cat.name}</span>
                        <span class="ml-2 text-xs font-medium px-2 py-0.5 rounded-full ${cat.type === 'income' ? 'bg-cyan-900 text-cyan-300' : 'bg-red-900 text-red-300'}">${cat.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <button class="edit-category-btn p-2 text-app-secondary hover:text-white" data-id="${cat.id}"><i data-lucide="pencil" class="w-4 h-4"></i></button>
                        <button class="delete-category-btn p-2 text-app-secondary hover:text-white" data-id="${cat.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            safeCreateIcons();
            
            container.querySelector('#add-category-form').addEventListener('submit', handleAddCategory);
            container.querySelectorAll('.edit-category-btn').forEach(btn => btn.addEventListener('click', (e) => handleEditCategory(e.currentTarget.dataset.id)));
            container.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showConfirmationModal('Konfirmasi Hapus', 'Yakin ingin menghapus kategori ini?', () => handleDeleteCategory(id));
            }));
        }

        // ===================================
        // ✨ GEMINI API FEATURES
        // ===================================
        function handleDescriptionInput(e) {
            clearTimeout(aiCategorizeTimeout);
            const description = e.target.value;
            if (description.length < 5) return;
            
            aiCategorizeTimeout = setTimeout(() => {
                suggestCategory(description);
            }, 1000);
        }

        async function suggestCategory(description) {
            const loader = document.getElementById('ai-cat-loader');
            loader.classList.remove('hidden');
            const expenseCategories = categories.filter(c => c.type === 'expense').map(c => c.name).join(', ');
            const prompt = `Berdasarkan deskripsi transaksi: "${description}", kategori mana yang paling cocok dari daftar ini? Kategori: ${expenseCategories}. Balas HANYA dengan nama kategori dari daftar tersebut.`;
            
            try {
                const responseText = await callGemini(prompt);
                const suggestedCategoryName = responseText.trim();
                const categorySelect = document.getElementById('category');
                
                for (let i = 0; i < categorySelect.options.length; i++) {
                    if (categorySelect.options[i].text.toLowerCase() === suggestedCategoryName.toLowerCase()) {
                        categorySelect.selectedIndex = i;
                        switchTransactionType('expense');
                        showToast(`✨ AI menyarankan kategori: ${suggestedCategoryName}`, 'info');
                        break;
                    }
                }
            } catch (error) {
                console.error("AI category suggestion failed:", error);
                showToast(error.message, 'error');
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        async function generateAiInsight() {
            const btn = document.getElementById('ai-insight-btn');
            const resultEl = document.getElementById('ai-insight-result');
            btn.disabled = true;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> Menganalisis...';
            safeCreateIcons();
            
            const recentTransactions = transactions.slice(0, 20).map(t => {
                const cat = categories.find(c => c.id === t.categoryId)?.name || 'Lainnya';
                return `${t.type} - ${cat}: ${t.description} (${formatCurrency(t.amount)})`;
            }).join('\n');

            if(transactions.length < 3){
                 showToast('Butuh minimal 3 transaksi untuk dianalisis.', 'info');
                 btn.disabled = false;
                 btn.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5"></i> Minta Analisis AI';
                 safeCreateIcons();
                 return;
            }

            const prompt = `Berikut adalah transaksi keuangan saya baru-baru ini:\n${recentTransactions}\nBerikan analisis singkat dan ramah tentang kebiasaan belanja saya dalam Bahasa Indonesia. Sebutkan kategori pengeluaran terbesar saya dan berikan satu tips hemat yang praktis dan bisa dilakukan. Buat jawaban kurang dari 50 kata.`;

            try {
                const insight = await callGemini(prompt);
                resultEl.textContent = insight;
                resultEl.classList.remove('hidden');
            } catch (error) {
                console.error("AI insight generation failed:", error);
                resultEl.textContent = "Gagal menghasilkan analisis. Coba lagi nanti.";
                resultEl.classList.remove('hidden');
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="sparkles" class="w-5 h-5"></i> Minta Analisis AI';
                safeCreateIcons();
            }
        }

        async function callGemini(prompt) {
            const key = localStorage.getItem('keuangan_apiKey') || "";
            if (!key) {
                throw new Error("Kunci API Gemini belum diatur di Pengaturan.");
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            }
            throw new Error("No content in API response.");
        }

        // ===================================
        // Utility Functions
        // ===================================
        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            renderCalendar();
        }

        function safeCreateIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                setTimeout(() => { if (typeof lucide !== 'undefined') { lucide.createIcons(); } }, 100);
            }
        }
        
        function setDateToToday() { document.getElementById('date').value = new Date().toISOString().split('T')[0]; }
        function formatCurrency(value) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(value); }
        
        function switchTransactionType(type) {
            document.getElementById('type').value = type;
            const incomeBtn = document.getElementById('type-income-btn');
            const expenseBtn = document.getElementById('type-expense-btn');
            if (type === 'income') {
                incomeBtn.className = 'w-full p-2 rounded-lg font-semibold accent-bg accent-ring ring-2';
                expenseBtn.className = 'w-full bg-app-tertiary p-2 rounded-lg font-semibold';
            } else {
                incomeBtn.className = 'w-full bg-app-tertiary p-2 rounded-lg font-semibold';
                expenseBtn.className = 'w-full p-2 rounded-lg font-semibold bg-red-600 ring-2 ring-red-400';
            }
            updateCategoryDropdowns();
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let bgColor, iconHTML;
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-600';
                    iconHTML = `<i data-lucide="check-circle" class="w-6 h-6 text-white"></i>`;
                    break;
                case 'error':
                    bgColor = 'bg-red-600';
                    iconHTML = `<i data-lucide="x-circle" class="w-6 h-6 text-white"></i>`;
                    break;
                case 'expense':
                    bgColor = 'bg-red-500';
                    iconHTML = `<i data-lucide="arrow-down" class="w-6 h-6 text-white"></i>`;
                    break;
                default: // info
                    bgColor = 'bg-app-tertiary';
                    iconHTML = `<i data-lucide="info" class="w-6 h-6 accent-text"></i>`;
                    break;
            }

            toast.className = `toast ${bgColor} text-white`;
            toast.innerHTML = `${iconHTML}<span>${message}</span>`;
            
            container.appendChild(toast);
            safeCreateIcons();

            setTimeout(() => {
                toast.classList.add('hiding');
                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }, 4000);
        }

        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            modal.querySelector('#confirmation-title').textContent = title;
            modal.querySelector('#confirmation-message').textContent = message;
            
            const buttonsEl = modal.querySelector('#confirmation-buttons');
            buttonsEl.innerHTML = `
                <button id="confirm-cancel-btn" class="bg-app-tertiary hover:opacity-80 text-white font-semibold py-2 px-6 rounded-lg transition">Batal</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Ya, Lanjutkan</button>
            `;

            modal.querySelector('#confirm-ok-btn').onclick = () => {
                modal.classList.add('hidden');
                onConfirm();
            };
            modal.querySelector('#confirm-cancel-btn').onclick = () => {
                modal.classList.add('hidden');
            };

            modal.classList.remove('hidden');
        }

        function exportToExcel() {
            if (transactions.length === 0) { showToast("Tidak ada data untuk diekspor.", 'info'); return; }
            const dataToExport = transactions.map(t => {
                const category = categories.find(c => c.id === t.categoryId) || { name: 'Tanpa Kategori' };
                return { 'Tanggal': new Date(t.date).toLocaleDateString('id-ID'), 'Deskripsi': t.description, 'Kategori': category.name, 'Pemasukan': t.type === 'income' ? t.amount : 0, 'Pengeluaran': t.type === 'expense' ? t.amount : 0, };
            });
            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Transaksi");
            const objectMaxLength = [];
            dataToExport.forEach(obj => { Object.keys(obj).forEach((key, i) => { let len = (obj[key] || "").toString().length; if (objectMaxLength[i] === undefined || objectMaxLength[i] < len) { objectMaxLength[i] = len; } }); });
            worksheet["!cols"] = objectMaxLength.map(w => ({ wch: w + 2 }));
            XLSX.writeFile(workbook, "Laporan_Keuangan.xlsx");
        }
    </script>
</body>
</html>
